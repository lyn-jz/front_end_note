# 图解Google V8笔记

## 开篇词：如何学习V8

### 如何学习V8？
先了解 JavaScript 这门语言的基本特性和设计思想，再学习V8执行 JavaScript 代码的完整流程。

## 1. V8是如何执行一段JavaScript代码的？

### 什么是V8？
V8 是由 Google 开发的开源 JavaScript 引擎，也被称为虚拟机，模拟实际计算机各种功能来实现代码的编译和执行。

### 高级代码为什么需要先编译再执行？
CPU 具有指令集（机器语言）用于实现各种功能，但是只能识别二进制的指令，不能直接识别由高级语言所编写的代码。有两种方式可以执行高级代码。  
1. 解释执行
  - 先将输入的源代码通过解析器编译成中间代码，之后直接使用解释器解释执行中间代码，然后直接输出结果。
  - 特点：启动速度快，执行时速度慢
2. 编译执行
  - 先将源代码转换为中间代码，然后编译器再将中间代码编译成机器代码并保存，在需要执行时直接执行。
  - 特点：启动速度慢，执行时的速度快

### V8 是怎么执行 JavaScript 代码的？
V8 使用即时编译技术（Just In Time），即混合编译执行和解释执行这两种手段。流程如下：
1. 初始化执行环境，包括“堆和栈空间”、“全局执行上下文”、“全局作用域”、“事件循环系统”等。
2. 解析（结构化）源代码，生成AST、作用域。
3. 解释器依据AST、作用域生成字节码，按照顺序解释字节码。
4. 监听热点代码。
    1. 重复多次执行的一段代码会被标记为热点代码
    2. 优化编译器将该段代码字节码编译为二进制代码并优化代码
    3. 该代码重复被执行时直接执行优化的二进制代码
    4. 执行过程中，如果对象的结构被动态修改了，优化代码无效。优化编译器执行反优化操作，经过反优化的代码下次执行时回退到解释器解释执行。

### 跟踪一段实际代码的执行流程
新建如下JS文件，并使用 D8 执行命令
```JavaScript
// test.js
var test = 'GeekTime'
```
```shell
# 命令
d8 --print-ast test.js # 查看AST
d8 --print-scopes test.js # 查看作用域
d8 --print-bytecode test.js # 生成字节码
d8 --trace-opt test.js # 查看优化的代码
pt --trace-deopt test.js # 查看反优化的代码
```

### 思考：除了 V8 采用了 JIT 技术，还有哪些虚拟机采用了 JIT 技术？
JVM以及luajit，包括oracle最新的graalVM都已经采用了JIT技术。

### 评论补充
使用 jsvu 来安装 js 引擎
1. 全局安装 jsvu： `npm install jsvu -g`
2. 将~/.jsvu路径添加到系统环境变量中：`export PATH="${HOME}/.jsvu:${PATH}"`
3. 可以直接通过命令参数指定：`jsvu --os=mac64 --engines=v8-debug。`

## 2. 



