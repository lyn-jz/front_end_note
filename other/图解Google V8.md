# 图解Google V8笔记

## 开篇词：如何学习V8

### 如何学习V8？
先了解 JavaScript 这门语言的基本特性和设计思想，再学习V8执行 JavaScript 代码的完整流程。

## 1. V8是如何执行一段JavaScript代码的？

### 什么是V8？
V8 是由 Google 开发的开源 JavaScript 引擎，也被称为虚拟机，模拟实际计算机各种功能来实现代码的编译和执行。

### 高级代码为什么需要先编译再执行？
CPU 具有指令集（机器语言）用于实现各种功能，但是只能识别二进制的指令，不能直接识别由高级语言所编写的代码。有两种方式可以执行高级代码。  
1. 解释执行
  - 先将输入的源代码通过解析器编译成中间代码，之后直接使用解释器解释执行中间代码，然后直接输出结果。
  - 特点：启动速度快，执行时速度慢
2. 编译执行
  - 先将源代码转换为中间代码，然后编译器再将中间代码编译成机器代码并保存，在需要执行时直接执行。
  - 特点：启动速度慢，执行时的速度快

### V8 是怎么执行 JavaScript 代码的？
V8 使用即时编译技术（Just In Time），即混合编译执行和解释执行这两种手段。流程如下：
1. 初始化执行环境，包括“堆和栈空间”、“全局执行上下文”、“全局作用域”、“事件循环系统”等。
2. 解析（结构化）源代码，生成AST、作用域。
3. 解释器依据AST、作用域生成字节码，按照顺序解释字节码。
4. 监听热点代码。
    1. 重复多次执行的一段代码会被标记为热点代码
    2. 优化编译器将该段代码字节码编译为二进制代码并优化代码
    3. 该代码重复被执行时直接执行优化的二进制代码
    4. 执行过程中，如果对象的结构被动态修改了，优化代码无效。优化编译器执行反优化操作，经过反优化的代码下次执行时回退到解释器解释执行。
![](./images/V8执行JavaScript流程图.jpg)


### 跟踪一段实际代码的执行流程
新建如下JS文件，并使用 D8 执行命令
```JavaScript
// test.js
var test = 'GeekTime'
```
```shell
# 命令
d8 --print-ast test.js # 查看AST
d8 --print-scopes test.js # 查看作用域
d8 --print-bytecode test.js # 生成字节码
d8 --trace-opt test.js # 查看优化的代码
pt --trace-deopt test.js # 查看反优化的代码
```

### 思考题：除了 V8 采用了 JIT 技术，还有哪些虚拟机采用了 JIT 技术？
JVM以及luajit，包括oracle最新的graalVM都已经采用了JIT技术。

### 评论补充：安装 js 引擎
1. 使用 jsvu
    1. 全局安装 jsvu： `npm install jsvu -g`
    2. 将~/.jsvu路径添加到系统环境变量中：`export PATH="${HOME}/.jsvu:${PATH}"`
    3. 可以直接通过命令参数指定：`jsvu --os=mac64 --engines=v8-debug。`
2. brew install v8


## 2. 函数即对象：JavaScript的函数特点
如果某个编程语言的函数，可以和这个语言的数据类型做一样的事情，我们就把这个语言中的函数称为一等公民。在 JavaScript 中，函数是一等公民。

### 函数的本质
函数是一种特殊的对象，它和对象一样可以拥有属性和值，但是函数和普通对象不同的是，函数可以被调用。

### V8 内部是怎么实现函数可调用特性的呢？
在 V8 内部，会为函数对象添加了两个隐藏属性，分别是 name 属性和 code 属性。name 属性的值就是函数名称，name 的默认属性值是 anonymous，表示函数对象没有被设置名称。code 属性代表函数代码，以字符串形式存储在内存中。当执行到该函数时，V8 会取出 code 属性值再解释执行。

### 函数关联了哪些内容
- 基础的属性和值
- 相关的执行上下文

### 思考题：哪些语言天生支持“函数是一等公民”？
kotlin和go、Python、Dart

## 3. 快属性和慢属性：V8是怎样提升对象属性访问速度的？

### 常规属性和排序属性
在 V8 内部，为了有效地提升存储和访问这两种属性的性能，分别使用了两个线性数据结构来分别保存排序属性和常规属性。
- 排序属性：数字属性，在V8 中称为element，按照索引值大小升序排列。
- 常规属性：字符串属性，在 V8 中被称为 properties，根据创建时的顺序升序排列。
![](./images/V8内部的对象构造.jpg)

为了优化在查找元素时，需要先找到 properties 对象才能找到对应的属性，多了一步操作而影响元素查找效率的问题，部分常规属性直接存储到对象本身，即对象内属性 (in-object properties)。对象内属性的数量是固定的，默认是 10 个，如果添加的属性超出了对象分配的空间，则它们将被保存在常规属性存储中。
![](./images/对象内属性.jpg)

### 快属性和慢属性
V8 具有快属性和慢属性两种存储策略，如果一个对象的属性过多时，V8 就会采取“慢属性”策略。
- 快属性：保存在线性数据结构中的属性。访问速度快，添加或者删除执行效率低，会产生大量时间和内存开销。
- 慢属性：保存在属性字典（hash表）中的属性。
![](./images/慢属性是如何存储的.jpg)

### 实践：在 Chrome 中查看对象布局
控制台执行以下代码->->Memory->左侧的小圆圈（take heap snapshot）->搜索Foo，查看系统快照。  
```JavaScript
function Foo(property_num, element_num) {
  //添加可索引属性
  for (let i = 0; i < element_num; i++) {
    this[i] = `element${i}`
  }
  //添加常规属性
  for (let i = 0; i < property_num; i++) {
    let ppt = `property${i}`
    this[ppt] = ppt
  }
}
var bar = new Foo(10, 10)
var bar2 = new Foo(20,10)
var bar3 = new Foo(500,10)
```
观察系统快照，除了 elements 和 properties 属性，V8 还为每个对象实现了 map 属性和`__proto__`属性。`__proto__`属性就是原型，是用来实现 JavaScript 继承的，map 则是隐藏类。

### 思考：结合文中介绍的快属性和慢属性，给出不建议使用 delete 的原因
如果删除属性在线性结构中，删除后需要移动元素，开销较大。
如果删除属性在慢属性中，可能需要将慢属性重排到快属性。

### 补充材料
[补充材料](https://www.cnblogs.com/chargeworld/p/12236848.html)

## 04. 函数表达式



















