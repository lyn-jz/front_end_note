# 浏览器工作原理与实践笔记

[TOC]

## 进程和线程
- 关系：
  - 一个进程就是一个程序的运行实例。启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。
  - 线程由进程来启动和管理的。线程依赖于进程，而进程中使用多线程并行处理能提升运算效率。
- 特点
  1. 进程中任意一线程执行出错，都会导致整个进程的崩溃
  2. 线程之间共享进程之中的数据
  3. 当一个进程关闭之后，操作系统会回收进程所占用的内存
  4. 进程之间内容互相隔离

## Chrome进程构架
![](./images/浏览器工作原理与实践/Chrome进程架构图.png)
- 浏览器进程。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- 渲染进程。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
- GPU 进程。其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。
- 网络进程。主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。
- 插件进程。主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

## 浏览器端发起HTTP请求流程
![](./images/浏览器工作原理与实践/HTTP请求流程示意图.png)
1. 构建请求
2. 查找缓存
3. 准备 IP 地址和端口(DNS将域名转为IP)
4. 等待 TCP 队列(同一个域名同时最多只能建立 6 个 TCP 连接)
5. 建立 TCP 连接
6. 发送 HTTP 请求
1. 服务器返回请求
2. 断开连接

## 从输入 URL 到页面展示（导航过程）
![](./images/浏览器工作原理与实践/从输入URL到页面展示完整流程示意图.png)
1. 用户输入：判断是输入的关键字是搜索内容，还是请求的 URL。回车之后执行当前页面的`beforeunload`事件，显示loading状态。
    - 搜索内容：地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
    - URL：地址栏会根据规则，把这段内容加上协议，合成为完整的 URL。
2. URL 请求过程：浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。接下来流程参考[浏览器端发起 HTTP 请求流程](#浏览器端发起HTTP请求流程)
    1. 解析响应头：在导航过程中，如果服务器响应行的状态码包含了 301、302 一类的跳转信息，浏览器会跳转到新的地址重新发起请求；如果响应行是 200，那么表示浏览器可以继续处理该请求。
    2. 响应数据类型处理：从`Content-Type`中得知返回的数据类型。如果 Content-Type 字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束。但如果是 HTML，那么浏览器则会继续进行导航流程。
3. 准备渲染进程：如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点[^1]的话，那么新页面会复用父页面的渲染进程（process-per-site-instance策略）。否则分配新的渲染进程。
4. 提交文档
    - 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；
    - 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
    - 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
    - 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。

[^1]:根域名和协议相同的网站定义为同一站点，包含该根域名下的所有子域名和不同的端口的网站。

























































## 拓展阅读
pac代理脚本、curl
[http缓存](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ)
